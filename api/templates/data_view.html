{{ define "content" }}
<div class="dashboard">
    <div class="page-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h1 class="page-title">Scraped Data</h1>
        <div class="actions">
            <a href="/api/data" class="btn btn-outline">
                <i class="fas fa-download" style="margin-right: 0.5rem;"></i>
                Export JSON
            </a>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h2 class="card-title">All Scraped Pages</h2>
            <div class="search-container">
                <div style="position: relative;">
                    <input type="text" id="table-search" placeholder="Search..." class="form-input" style="padding-left: 2.5rem;">
                    <i class="fas fa-search" style="position: absolute; left: 1rem; top: 0.75rem; color: var(--gray);"></i>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-container">
                <table id="scraped-data-table">
                    <thead>
                        <tr>
                            <th data-sort="url">URL <i class="fas fa-sort"></i></th>
                            <th data-sort="date">Scraped At <i class="fas fa-sort"></i></th>
                            <th data-sort="hash">Content Hash <i class="fas fa-sort"></i></th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{ range .Pages }}
                        <tr>
                            <td class="table-url" data-url="{{ .URL }}">
                                <a href="{{ .URL }}" target="_blank" title="{{ .URL }}">{{ .URL }}</a>
                            </td>
                            <td data-date="{{ .ScrapedAt.Format "2006-01-02T15:04:05Z07:00" }}">
                                {{ .ScrapedAt.Format "Jan 02, 2006 15:04:05" }}
                            </td>
                            <td class="hash" data-hash="{{ .ContentHash }}">
                                <div class="tooltip">
                                    {{ if gt (len .ContentHash) 10 }}
                                        {{ slice .ContentHash 0 10 }}...
                                    {{ else }}
                                        {{ .ContentHash }}
                                    {{ end }}
                                    <span class="tooltip-text">{{ .ContentHash }}</span>
                                </div>
                            </td>
                            <td>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-outline" onclick="viewDetails('{{ .ContentHash }}')" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline" onclick="rescrapeUrl('{{ .URL }}')" title="Rescrape URL">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {{ else }}
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 2rem;">
                                <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem;">
                                    <i class="fas fa-spider" style="font-size: 3rem; color: var(--gray);"></i>
                                    <p>No pages have been scraped yet.</p>
                                    <a href="/scrape" class="btn btn-primary">Start Scraping</a>
                                </div>
                            </td>
                        </tr>
                        {{ end }}
                    </tbody>
                </table>
            </div>
            
            {{ if gt .TotalPages 1 }}
            <div class="pagination">
                {{ $currentPage := .CurrentPage }}
                {{ $totalPages := .TotalPages }}
                
                {{ if gt $currentPage 1 }}
                <a href="/view/data?page={{ sub $currentPage 1 }}&limit={{ .Limit }}" class="page-link">
                    <i class="fas fa-chevron-left"></i>
                </a>
                {{ end }}
                
                {{ range $i := .PageNumbers }}
                <a href="/view/data?page={{ $i }}&limit={{ $.Limit }}" class="page-link {{ if eq $i $currentPage }}active{{ end }}">
                    {{ $i }}
                </a>
                {{ end }}
                
                {{ if lt $currentPage $totalPages }}
                <a href="/view/data?page={{ add $currentPage 1 }}&limit={{ .Limit }}" class="page-link">
                    <i class="fas fa-chevron-right"></i>
                </a>
                {{ end }}
            </div>
            {{ end }}
        </div>
    </div>
</div>

<!-- Modal for viewing details (hidden by default) -->
<div id="details-modal" class="modal" style="display: none;">
    <div class="modal-overlay" onclick="closeModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>Page Details</h3>
            <button onclick="closeModal()" class="modal-close"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div id="details-content">Loading...</div>
        </div>
    </div>
</div>
{{ end }}

{{ define "scripts" }}
<script>
    // Function to view details in modal
    function viewDetails(contentHash) {
        const modal = document.getElementById('details-modal');
        const detailsContent = document.getElementById('details-content');
        
        modal.style.display = 'flex';
        detailsContent.innerHTML = '<div class="loader"></div> Loading details...';
        
        // Fetch details from API
        fetch(`/api/page/${contentHash}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Format and display the data
                detailsContent.innerHTML = `
                    <div class="details-container">
                        <div class="details-item">
                            <div class="details-label">URL</div>
                            <div class="details-value">
                                <a href="${data.url}" target="_blank">${data.url}</a>
                            </div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Scraped At</div>
                            <div class="details-value">${new Date(data.scraped_at).toLocaleString()}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Content Hash</div>
                            <div class="details-value">${data.content_hash}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">HTTP Status</div>
                            <div class="details-value">${data.http_status || 'N/A'}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Content Type</div>
                            <div class="details-value">${data.content_type || 'N/A'}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Size</div>
                            <div class="details-value">${formatBytes(data.size || 0)}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Title</div>
                            <div class="details-value">${data.title || 'N/A'}</div>
                        </div>
                    </div>
                `;
            })
            .catch(error => {
                detailsContent.innerHTML = `<div class="error-message">Error loading details: ${error.message}</div>`;
            });
    }
    
    // Function to close modal
    function closeModal() {
        document.getElementById('details-modal').style.display = 'none';
    }
    
    // Function to rescrape a URL
    function rescrapeUrl(url) {
        if (confirm(`Are you sure you want to rescrape ${url}?`)) {
            fetch('/api/enqueue', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `url=${encodeURIComponent(url)}`
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.text();
            })
            .then(data => {
                alert('URL has been requeued for scraping');
            })
            .catch(error => {
                alert(`Error: ${error.message}`);
            });
        }
    }
    
    // Helper function to format bytes
    function formatBytes(bytes, decimals = 2) {
        if (bytes === 0) return '0 Bytes';
        
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }
</script>

<style>
    /* Modal styles */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    
    .modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(3px);
    }
    
    .modal-content {
        background-color: white;
        border-radius: 0.5rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        z-index: 1001;
        position: relative;
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.25rem;
        border-bottom: 1px solid var(--border);
    }
    
    .modal-body {
        padding: 1.5rem;
    }
    
    .modal-close {
        background: transparent;
        border: none;
        font-size: 1.25rem;
        cursor: pointer;
        color: var(--gray);
    }
    
    .details-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .details-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }
    
    .details-label {
        font-weight: 600;
        font-size: 0.875rem;
        color: var(--gray);
    }
    
    .details-value {
        word-break: break-all;
    }
    
    .error-message {
        color: var(--danger);
        padding: 1rem;
        text-align: center;
        background-color: #fee2e2;
        border-radius: 0.375rem;
    }
</style>
{{ end }}
