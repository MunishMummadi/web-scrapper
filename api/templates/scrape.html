{{ define "content" }}
<div class="dashboard">
    <h1 class="page-title">Scrape URLs</h1>
    
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Submit URL</h2>
        </div>
        <div class="card-body">
            <form id="url-form">
                <div class="form-group">
                    <label for="url-input" class="form-label">URL to Scrape</label>
                    <input type="url" id="url-input" placeholder="https://example.com" class="form-input" required>
                    <p class="form-hint">Enter a complete URL including http:// or https://</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Scraping Options</label>
                    <div class="checkbox-group">
                        <label class="checkbox">
                            <input type="checkbox" id="follow-links" checked>
                            <span>Follow links (crawl)</span>
                        </label>
                        
                        <label class="checkbox">
                            <input type="checkbox" id="same-domain-only" checked>
                            <span>Stay on same domain</span>
                        </label>
                        
                        <label class="checkbox">
                            <input type="checkbox" id="include-images">
                            <span>Download images</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="max-depth" class="form-label">Maximum Crawl Depth</label>
                    <div class="input-with-tooltip">
                        <input type="range" id="max-depth" min="1" max="10" value="3" class="range-input">
                        <span id="max-depth-value">3</span>
                        <div class="tooltip">
                            <i class="fas fa-info-circle"></i>
                            <span class="tooltip-text">
                                Higher values will scrape more pages but take longer to complete.
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="rate-limit" class="form-label">Rate Limiting (requests per minute)</label>
                    <div class="input-with-tooltip">
                        <input type="range" id="rate-limit" min="10" max="120" step="10" value="60" class="range-input">
                        <span id="rate-limit-value">60</span>
                        <div class="tooltip">
                            <i class="fas fa-info-circle"></i>
                            <span class="tooltip-text">
                                Lower values are more considerate to target websites.
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" id="url-submit" class="btn btn-primary">
                        <i class="fas fa-spider btn-icon"></i> Start Scraping
                    </button>
                </div>
                
                <div id="status-message" class="form-message"></div>
            </form>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Bulk Scraping</h2>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label for="bulk-urls" class="form-label">URLs (one per line)</label>
                <textarea id="bulk-urls" class="form-input" rows="5" placeholder="https://example.com&#10;https://anothersite.org"></textarea>
            </div>
            
            <div class="form-actions">
                <button id="bulk-submit" class="btn btn-primary">
                    <i class="fas fa-upload btn-icon"></i> Submit URLs
                </button>
            </div>
            
            <div id="bulk-status-message" class="form-message"></div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Active Jobs</h2>
            <button id="refresh-jobs" class="btn btn-outline">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
        <div class="card-body">
            <div class="table-container">
                <table id="jobs-table">
                    <thead>
                        <tr>
                            <th>URL</th>
                            <th>Status</th>
                            <th>Progress</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr id="no-jobs-row">
                            <td colspan="4" style="text-align: center;">No active jobs.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{{ end }}

{{ define "scripts" }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Update max depth range display
        const maxDepthInput = document.getElementById('max-depth');
        const maxDepthValue = document.getElementById('max-depth-value');
        
        maxDepthInput.addEventListener('input', function() {
            maxDepthValue.textContent = this.value;
        });
        
        // Update rate limit range display
        const rateLimitInput = document.getElementById('rate-limit');
        const rateLimitValue = document.getElementById('rate-limit-value');
        
        rateLimitInput.addEventListener('input', function() {
            rateLimitValue.textContent = this.value;
        });
        
        // URL form submission
        const urlForm = document.getElementById('url-form');
        const urlSubmit = document.getElementById('url-submit');
        const statusMessage = document.getElementById('status-message');
        
        urlForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const url = document.getElementById('url-input').value;
            const followLinks = document.getElementById('follow-links').checked;
            const sameDomainOnly = document.getElementById('same-domain-only').checked;
            const includeImages = document.getElementById('include-images').checked;
            const maxDepth = document.getElementById('max-depth').value;
            const rateLimit = document.getElementById('rate-limit').value;
            
            if (!url) {
                showFormError(statusMessage, 'Please enter a URL');
                return;
            }
            
            // Show loading state
            urlSubmit.disabled = true;
            urlSubmit.innerHTML = '<span class="loader"></span> Processing';
            statusMessage.textContent = '';
            
            // Prepare form data
            const formData = new FormData();
            formData.append('url', url);
            formData.append('follow_links', followLinks);
            formData.append('same_domain_only', sameDomainOnly);
            formData.append('include_images', includeImages);
            formData.append('max_depth', maxDepth);
            formData.append('rate_limit', rateLimit);
            
            // Make API request to enqueue URL
            fetch('/api/enqueue', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.text();
            })
            .then(data => {
                showFormSuccess(statusMessage, 'URL successfully queued for scraping');
                document.getElementById('url-input').value = '';
                refreshJobsList();
            })
            .catch(error => {
                showFormError(statusMessage, `Error: ${error.message}`);
            })
            .finally(() => {
                // Reset button state
                urlSubmit.disabled = false;
                urlSubmit.innerHTML = '<i class="fas fa-spider btn-icon"></i> Start Scraping';
            });
        });
        
        // Bulk URL submission
        const bulkSubmit = document.getElementById('bulk-submit');
        const bulkStatusMessage = document.getElementById('bulk-status-message');
        
        bulkSubmit.addEventListener('click', function() {
            const urls = document.getElementById('bulk-urls').value.trim().split(/\r?\n/);
            const filteredUrls = urls.filter(url => url.trim() !== '');
            
            if (filteredUrls.length === 0) {
                showFormError(bulkStatusMessage, 'Please enter at least one URL');
                return;
            }
            
            // Show loading state
            bulkSubmit.disabled = true;
            bulkSubmit.innerHTML = '<span class="loader"></span> Processing';
            bulkStatusMessage.textContent = '';
            
            let successCount = 0;
            let failCount = 0;
            let promises = [];
            
            // Queue each URL
            filteredUrls.forEach(url => {
                const formData = new FormData();
                formData.append('url', url);
                
                const promise = fetch('/api/enqueue', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed for ${url}`);
                    }
                    successCount++;
                    return response.text();
                })
                .catch(error => {
                    failCount++;
                    console.error(error);
                });
                
                promises.push(promise);
            });
            
            // Wait for all requests to complete
            Promise.allSettled(promises)
                .then(() => {
                    let message = `Processed ${filteredUrls.length} URLs: `;
                    message += `${successCount} succeeded, ${failCount} failed.`;
                    
                    if (failCount > 0) {
                        showFormWarning(bulkStatusMessage, message);
                    } else {
                        showFormSuccess(bulkStatusMessage, message);
                    }
                    
                    document.getElementById('bulk-urls').value = '';
                    refreshJobsList();
                })
                .finally(() => {
                    // Reset button state
                    bulkSubmit.disabled = false;
                    bulkSubmit.innerHTML = '<i class="fas fa-upload btn-icon"></i> Submit URLs';
                });
        });
        
        // Refresh jobs list
        const refreshJobsButton = document.getElementById('refresh-jobs');
        refreshJobsButton.addEventListener('click', refreshJobsList);
        
        // Initial jobs list refresh
        refreshJobsList();
    });
    
    // Function to refresh jobs list
    function refreshJobsList() {
        const jobsTable = document.getElementById('jobs-table');
        const tableBody = jobsTable.querySelector('tbody');
        const noJobsRow = document.getElementById('no-jobs-row');
        
        fetch('/api/jobs')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Clear existing rows except for no-jobs-row
                Array.from(tableBody.children).forEach(child => {
                    if (child.id !== 'no-jobs-row') {
                        child.remove();
                    }
                });
                
                if (data.jobs && data.jobs.length > 0) {
                    // Hide no jobs message
                    noJobsRow.style.display = 'none';
                    
                    // Add job rows
                    data.jobs.forEach(job => {
                        const row = document.createElement('tr');
                        
                        // URL cell
                        const urlCell = document.createElement('td');
                        urlCell.className = 'table-url';
                        const urlLink = document.createElement('a');
                        urlLink.href = job.url;
                        urlLink.target = '_blank';
                        urlLink.title = job.url;
                        urlLink.textContent = job.url;
                        urlCell.appendChild(urlLink);
                        
                        // Status cell
                        const statusCell = document.createElement('td');
                        const statusBadge = document.createElement('span');
                        statusBadge.className = `badge badge-${getStatusClass(job.status)}`;
                        statusBadge.textContent = job.status;
                        statusCell.appendChild(statusBadge);
                        
                        // Progress cell
                        const progressCell = document.createElement('td');
                        const progressBar = document.createElement('div');
                        progressBar.className = 'progress-bar';
                        const progressValue = document.createElement('div');
                        progressValue.className = 'progress-value';
                        progressValue.style.width = `${job.progress || 0}%`;
                        progressBar.appendChild(progressValue);
                        progressCell.appendChild(progressBar);
                        
                        // Actions cell
                        const actionsCell = document.createElement('td');
                        actionsCell.innerHTML = `
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-outline" onclick="pauseJob('${job.id}')" ${job.status === 'paused' ? 'disabled' : ''}>
                                    <i class="fas fa-pause"></i>
                                </button>
                                <button class="btn btn-outline" onclick="resumeJob('${job.id}')" ${job.status !== 'paused' ? 'disabled' : ''}>
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="btn btn-danger" onclick="cancelJob('${job.id}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `;
                        
                        row.appendChild(urlCell);
                        row.appendChild(statusCell);
                        row.appendChild(progressCell);
                        row.appendChild(actionsCell);
                        
                        tableBody.appendChild(row);
                    });
                } else {
                    // Show no jobs message
                    noJobsRow.style.display = 'table-row';
                }
            })
            .catch(error => {
                console.error('Error fetching jobs:', error);
                // Show error message in table
                noJobsRow.style.display = 'table-row';
                noJobsRow.querySelector('td').textContent = 'Error loading jobs: ' + error.message;
            });
    }
    
    // Helper to get status CSS class
    function getStatusClass(status) {
        switch (status.toLowerCase()) {
            case 'running':
                return 'info';
            case 'completed':
                return 'success';
            case 'paused':
                return 'warning';
            case 'failed':
            case 'canceled':
                return 'danger';
            default:
                return 'info';
        }
    }
    
    // Job control functions
    function pauseJob(jobId) {
        fetch(`/api/jobs/${jobId}/pause`, {
            method: 'POST'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error ${response.status}`);
            }
            return response.text();
        })
        .then(() => {
            refreshJobsList();
        })
        .catch(error => {
            alert(`Failed to pause job: ${error.message}`);
        });
    }
    
    function resumeJob(jobId) {
        fetch(`/api/jobs/${jobId}/resume`, {
            method: 'POST'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error ${response.status}`);
            }
            return response.text();
        })
        .then(() => {
            refreshJobsList();
        })
        .catch(error => {
            alert(`Failed to resume job: ${error.message}`);
        });
    }
    
    function cancelJob(jobId) {
        if (confirm('Are you sure you want to cancel this job?')) {
            fetch(`/api/jobs/${jobId}/cancel`, {
                method: 'POST'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.text();
            })
            .then(() => {
                refreshJobsList();
            })
            .catch(error => {
                alert(`Failed to cancel job: ${error.message}`);
            });
        }
    }
    
    // Helper to show form success message
    function showFormSuccess(element, message) {
        element.textContent = message;
        element.className = 'form-message success';
        setTimeout(() => {
            element.textContent = '';
            element.className = 'form-message';
        }, 5000);
    }
    
    // Helper to show form error message
    function showFormError(element, message) {
        element.textContent = message;
        element.className = 'form-message error';
    }
    
    // Helper to show form warning message
    function showFormWarning(element, message) {
        element.textContent = message;
        element.className = 'form-message warning';
        setTimeout(() => {
            element.textContent = '';
            element.className = 'form-message';
        }, 5000);
    }
</script>

<style>
    /* Form styles */
    .form-hint {
        font-size: 0.875rem;
        color: var(--gray);
        margin-top: 0.25rem;
    }
    
    .form-actions {
        margin-top: 1.5rem;
    }
    
    .form-message {
        margin-top: 1rem;
        padding: 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
    }
    
    .form-message.success {
        background-color: #dcfce7;
        color: #15803d;
    }
    
    .form-message.error {
        background-color: #fee2e2;
        color: #b91c1c;
    }
    
    .form-message.warning {
        background-color: #fef3c7;
        color: #b45309;
    }
    
    /* Checkbox styles */
    .checkbox-group {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .checkbox {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
    }
    
    .checkbox input {
        width: 1rem;
        height: 1rem;
    }
    
    /* Range input styles */
    .range-input {
        width: 100%;
        max-width: 300px;
    }
    
    .input-with-tooltip {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    /* Progress bar styles */
    .progress-bar {
        width: 100%;
        background-color: #e2e8f0;
        border-radius: 9999px;
        height: 0.5rem;
        overflow: hidden;
    }
    
    .progress-value {
        height: 100%;
        background-color: var(--primary);
        border-radius: 9999px;
    }
</style>
{{ end }}
